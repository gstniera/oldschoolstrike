{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Oldschool Strike</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
{% include 'modal.html' %} {# make sure modal is present so showModal/hideModal exist #}

<div class="bg-[#eaf6ff] w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-[#395886] mb-2">Hi, {{username}} !! </h1>
      <h1 class="text font-semibold text-[#395886] mb-2">Take a look at our latest product ᕙ( •̀ ᗜ •́ )ᕗ</h1>
    </div>

    <!-- Filter -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-[#FFFFFF] rounded-lg border border-[#D5DEEF] p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <a id="filter-all" class="bg-[#628ECB] text-white border px-4 py-2 rounded-md font-medium hover:bg-[#395886] transition"> ALL PRODUCTS₊˚⊹♡ </a>
        <a id="filter-my" class="bg-[#D5DEEF] text-[#395886] border px-4 py-2 rounded-md font-medium hover:bg-[#395886] hover:text-white transition"> MY PRODUCTS(˶ˆ꒳ˆ˵) </a>
      </div>

      {% if user.is_authenticated %}
      <div class="flex flex-col items-end text-sm text-gray-500">
        <div>──.✦Last login: {{ last_login }}</div>
        <button id="refreshProductsBtn" class="mt-2 inline-flex items-center px-4 py-2 bg-white text-[#8aaee0] font-semibold outline outline-2 outline-[#8aaee0] rounded-md hover:bg-[#8aaee0] hover:text-white transition" title="Refresh products">
          <span id="refreshIcon" aria-hidden="true" style="display:inline-block; transform-origin:center;"> ↻ </span>
          <span class="ml-2">Refresh Product</span>
        </button>
      </div>
      {% endif %}
    </div>

    <!-- States -->
    <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-[#628ECB] inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-700 mt-3">Loading product...⊹</p>
    </div>

    <div id="error" class="hidden"></div>
    <div id="grid" class="hidden"></div>

    <!-- Delete Modal -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
      <div class="bg-white rounded-lg shadow-lg w-11/12 sm:w-3/5 md:w-1/3 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Delete Confirmation</h3>
        <p class="text-sm text-gray-600 mb-4">Are you sure you want to remove product <span id="deleteProductName" class="font-medium"></span> (づ •. •)?</p>
        <div class="flex justify-end gap-3">
          <button id="cancelDeleteBtn" class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-200">Cancel</button>
          <button id="confirmDeleteBtn" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-800">Delete</button>
        </div>
      </div>
    </div>

    <!-- Empty -->
    <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/no-product.png' %}" alt="No product available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No product at the moment...</h3>
      <p class="text-gray-500 mb-6">Be the first to share your product with the community( - ᴗ •́ )!!</p>
      <a href="javascript:void(0)" onclick="showModal('create')" class="inline-flex items-center px-4 py-2 bg-[#2F80E4] text-white rounded-md hover:bg-[#395886] transition"> ⤷"Create Product ˎˊ˗ </a>
    </div>

  </div>
</div>

<script>
/* ---------- Config / constants (unchanged endpoints & template tags) ---------- */
const PRODUCT_API_ENDPOINT = "{% url 'main:show_json' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";
const DELETE_PRODUCT_AJAX_TEMPLATE = "{% url 'main:delete_product_ajax' '00000000-0000-0000-0000-000000000000' %}";
const UPDATE_PRODUCT_AJAX_TEMPLATE = "{% url 'main:update_product_ajax' '00000000-0000-0000-0000-000000000000' %}";
const ADD_PRODUCT_AJAX_URL = "{% url 'main:add_product_entry_ajax' %}";

/* ---------- tiny DOM helpers ---------- */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

/* ---------- safe sanitize (DOMPurify if available, otherwise escape) ---------- */
function safeSanitize(s) {
  try { if (window.DOMPurify?.sanitize) return DOMPurify.sanitize(String(s || '')); } catch(e){}
  return String(s == null ? '' : s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ---------- small utilities ---------- */
function getCookie(name){ const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
function buildUrlFromTemplate(tmpl, id){ return tmpl ? tmpl.replace('00000000-0000-0000-0000-000000000000', encodeURIComponent(String(id||''))) : tmpl; }
function fmtPrice(v){ v = Number(v||0); return v ? new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(v) : ''; }
function readCategory(cat){ const m = { 'almost_gone':'Almost gone', 'exclusive':'Exclusive', 'popular':'Popular' }; const s = String(cat||'').toLowerCase().trim(); return m[s]||cat||''; }

/* ---------- DOM refs (must match markup) ---------- */
const loadingSpinner = $('#loading');
const errorMessage = $('#error');
const emptyStateDisplay = $('#empty');
const productGridContainer = $('#grid');
const showAllProductButton = $('#filter-all');
const showMyProductButton = $('#filter-my');
const refreshBtn = $('#refreshProductsBtn');
const refreshIcon = $('#refreshIcon');
const deleteModal = $('#deleteConfirmModal');
const deleteNameSpan = $('#deleteProductName');
const cancelDeleteBtn = $('#cancelDeleteBtn');
const confirmDeleteBtn = $('#confirmDeleteBtn');

let activeFilter = 'all';
let allProductData = [];

/* ---------- UI toggles ---------- */
function displayPageSection({ showLoading=false, showError=false, showEmpty=false, showGrid=false } = {}) {
  if (loadingSpinner) loadingSpinner.classList.toggle('hidden', !showLoading);
  if (errorMessage) errorMessage.classList.toggle('hidden', !showError);
  if (emptyStateDisplay) emptyStateDisplay.classList.toggle('hidden', !showEmpty);
  if (productGridContainer) {
    productGridContainer.classList.toggle('hidden', !showGrid);
    if (showGrid) productGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
  }
}
function setFilterAppearance() {
  const A = 'bg-[#628ECB] text-white px-4 py-2 rounded-md font-medium hover:bg-[#395886] transition';
  const I = 'bg-[#D5DEEF] text-[#395886] px-4 py-2 rounded-md font-medium hover:bg-[#395886] hover:text-white transition';
  if (showAllProductButton) showAllProductButton.className = activeFilter === 'all' ? A : I;
  if (showMyProductButton) showMyProductButton.className = activeFilter === 'my' ? A : I;
}

/* ---------- product card builder (layout unchanged) ---------- */
function buildProductCardElement(product){
  const safeId = safeSanitize(String(product.id||''));
  const safeName = String(product.name||'');
  const safeDesc = String(product.description||'');
  const safeThumb = safeSanitize(String(product.thumbnail||''));
  const price = Number(product.price||0);
  const category = readCategory(product.category);
  const ownerId = product.user_id || product.user?.id || null;

  const detailLink = "{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', safeId);

  const article = document.createElement('article');
  article.className = 'font-sans flex flex-col h-full bg-white rounded-lg border hover:shadow-lg transition overflow-hidden';

  article.innerHTML = `
    <div class="relative overflow-hidden flex-none">
      ${safeThumb ? `<img src="${safeThumb}" alt="${safeName}" class="w-full h-72 object-contain bg-white">` : `<div class="w-full h-72 bg-[#F3F8FB]"></div>`}
    </div>
    <div class="p-4 flex-1 flex flex-col justify-between">
      <div>
        <div class="text-2xl font-extrabold text-[#111827] mb-2">${fmtPrice(price)}</div>
        <h2 class="text-sm text-[#111827] font-medium mb-3 line-clamp-2">
          <span class="text-[#0F6FB8] font-semibold">[${category}]</span>
          <a href="${detailLink}" class="hover:text-[#0F6FB8] ml-1">${safeSanitize(safeName)}</a>
        </h2>
        <p class="text-sm text-gray-600 line-clamp-3 mb-4">⤷ ゛${safeSanitize(safeDesc.slice(0,170))}${safeDesc.length>170?'...':''}</p>
      </div>
      <div class="flex items-center justify-between pt-3 border-t border-gray-100">
        <a href="${detailLink}" class="text-[#0F6FB8] font-medium text-sm hover:text-[#395886] transition">Details─.✦></a>
        ${String(CURRENT_USER_ID) === String(ownerId) ? 
          `<div class="flex items-center space-x-3">
            <button type="button" onclick="openEditModal('${safeId}')"
                    class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium bg-[#D5DEEF] text-gray-700 hover:bg-[#395886] hover:text-white transition">
              Edit
            </button>

            <button type="button"
                    class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium bg-red-600 text-white hover:bg-red-800 delete-btn"
                    data-delete-id="${safeId}"
                    data-delete-name="${safeSanitize(safeName).replace(/\"/g,'&quot;').replace(/'/g,'&#39;')}">
              Delete
            </button>
          </div>` : '' }
      </div>
    </div>`;

  return article;
}
function renderAllProductCards(items){
  if (!productGridContainer) return;
  productGridContainer.innerHTML = '';
  items.forEach(i => productGridContainer.appendChild(buildProductCardElement(i)));
}

/* ---------- filtering & display ---------- */
function filterAndDisplayProduct(){
  setFilterAppearance();
  const filtered = activeFilter === 'all' ? allProductData : allProductData.filter(p => Number(p.user_id) === Number(CURRENT_USER_ID));
  if (filtered.length) { renderAllProductCards(filtered); displayPageSection({ showGrid: true }); }
  else displayPageSection({ showEmpty: true });
}

/* ---------- fetch products ---------- */
async function fetchProductFromServer(){
  const old = $('#fetchErrorFallback'); if (old) old.remove();
  displayPageSection({ showLoading: true });

  try {
    const res = await fetch(PRODUCT_API_ENDPOINT, { headers: { 'Accept':'application/json' }, credentials: 'same-origin' });
    if (!res.ok) throw new Error('fetch failed');
    const data = await res.json();
    allProductData = data || [];
    filterAndDisplayProduct();
    if (typeof showToast === 'function') showToast('Daftar produk berhasil diperbarui', 'success');
  } catch (err) {
    console.error('Error loading product:', err);
    displayPageSection({ showLoading: false });

    const fallback = document.createElement('div');
    fallback.id = 'fetchErrorFallback';
    fallback.className = 'flex flex-col items-center justify-center text-center text-[#395886] bg-white border border-[#d1d5db] rounded-lg p-8 mt-8 shadow-sm';
    fallback.innerHTML = `
      <div class="text-4xl mb-3">( ꩜ ᯅ ꩜;)</div>
      <div class="text-lg font-semibold mb-2">Server Error</div>
      <div class="text-sm mb-4 text-gray-600">Tidak dapat memuat produk. Pastikan server Django sedang berjalan.</div>
      <button id="retryFetchBtn" class="px-4 py-2 bg-[#395886] text-white rounded-md hover:bg-[#628ECB] transition-colors">Try Again</button>
    `;
    (productGridContainer?.parentNode || document.body).appendChild(fallback);
    $('#retryFetchBtn')?.addEventListener('click', () => { fallback.remove(); fetchProductFromServer(); });
    if (typeof showToast === 'function') showToast('Gagal memuat produk dari server.', 'error');
  }
}

/* ---------- refresh spinner (keeps behavior) ---------- */
(function attachRefresh(){
  if (!refreshBtn || !refreshIcon) return;
  let lastClick = 0, angle = 0, timer = null;
  const start = () => timer = setInterval(()=>{ angle = (angle+90)%360; refreshIcon.style.transform = `rotate(${angle}deg)`; }, 120);
  const stop = () => { clearInterval(timer); refreshIcon.style.transform = 'rotate(0deg)'; timer = null; angle = 0; };

  refreshBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    if (Date.now() - lastClick < 2000) return;
    lastClick = Date.now();
    refreshBtn.disabled = true; refreshBtn.classList.add('opacity-70','cursor-not-allowed'); start();
    try { await fetchProductFromServer(); showToast?.('Daftar produk diperbarui','success'); }
    catch { showToast?.('Gagal memperbarui produk — cek koneksi','error'); }
    finally { refreshBtn.disabled = false; refreshBtn.classList.remove('opacity-70','cursor-not-allowed'); stop(); }
  });
})();

/* ---------- delete modal logic ---------- */
(function initDeleteModal(){
  let pendingId = null;
  window.showDeleteConfirm = (id, name) => {
    pendingId = id;
    if (deleteNameSpan) deleteNameSpan.textContent = name || '';
    deleteModal?.classList.remove('hidden');
    confirmDeleteBtn?.focus();
  };
  const hide = () => { pendingId = null; if (deleteNameSpan) deleteNameSpan.textContent = ''; deleteModal?.classList.add('hidden'); };
  cancelDeleteBtn?.addEventListener('click', hide);

  confirmDeleteBtn?.addEventListener('click', async () => {
    if (!pendingId) return hide();
    confirmDeleteBtn.disabled = true;
    try {
      const url = buildUrlFromTemplate(DELETE_PRODUCT_AJAX_TEMPLATE, pendingId);
      const r = await fetch(url, { method:'POST', headers:{ 'X-CSRFToken': getCookie('csrftoken') }, credentials:'same-origin' });
      showToast?.(r.ok ? 'Product deleted' : 'Delete failed', r.ok ? 'success' : 'error');
      if (r.ok) fetchProductFromServer();
    } catch (e) {
      console.error(e);
      showToast?.('Gagal menghapus produk.','error');
    } finally {
      confirmDeleteBtn.disabled = false;
      hide();
    }
  });
})();

/* ---------- openEditModal (loads product into modal) ---------- */
async function openEditModal(productId){
  if (!productId) return console.warn('openEditModal called without id');
  const url = "{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', productId);
  try {
    const resp = await fetch(url, { headers:{ 'Accept':'application/json' }, credentials:'same-origin' });
    if (!resp.ok) { showToast?.('Failed to load product for edit', 'error'); return; }
    const data = await resp.json();
    $('#product_id').value = data.id || productId;
    $('#title').value = data.name || '';
    $('#price').value = data.price || '';
    $('#content').value = data.description || '';
    $('#category').value = data.category || '';
    $('#thumbnail').value = data.thumbnail || '';
    $('#is_featured').checked = !!data.is_featured;
    if (typeof showModal === 'function') showModal('edit');
  } catch (e) {
    console.error('openEditModal error', e);
    showToast?.('Error loading product', 'error');
  }
}

/* ---------- modal form handling (create OR update) ---------- */
document.addEventListener('DOMContentLoaded', () => {
  const modalForm = $('#productForm');
  if (modalForm) {
    // remove old handlers by replacing with a clone (defensive)
    const clone = modalForm.cloneNode(true);
    modalForm.parentNode.replaceChild(clone, modalForm);

    clone.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const productId = String($('#product_id').value || '').trim();
      const formData = new FormData(clone);

      if (!formData.get('name') || !formData.get('description') || formData.get('price') === null) {
        showToast?.('Nama, harga, dan deskripsi wajib diisi.', 'error');
        return;
      }

      try {
        if (productId) {
          // UPDATE
          const url = buildUrlFromTemplate(UPDATE_PRODUCT_AJAX_TEMPLATE, productId);
          const resp = await fetch(url, { method:'POST', headers:{ 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }, body: formData, credentials:'same-origin' });
          if (resp.ok) { showToast?.('Product updated successfully!', 'success'); hideModal?.(); document.dispatchEvent(new CustomEvent('productUpdated')); }
          else { let body = '<no body>'; try { body = await resp.text(); } catch(e){} showToast?.('Update failed: '+resp.status+' '+body, 'error'); }
        } else {
          // CREATE
          let url = ADD_PRODUCT_AJAX_URL || '/create-product-ajax/';
          if (!url.endsWith('/')) url += '/';
          const resp = await fetch(url, { method:'POST', headers:{ 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }, body: formData, credentials:'same-origin' });
          if (resp.ok || resp.status === 201) { showToast?.('Product created successfully!', 'success'); hideModal?.(); document.dispatchEvent(new CustomEvent('productAdded')); }
          else { let body = '<no body>'; try { body = await resp.text(); } catch(e){} showToast?.('Create failed: '+resp.status+' '+body, 'error'); }
        }
      } catch (err) {
        console.error('submit error', err);
        showToast?.('Gagal terhubung ke server.', 'error');
      }
    });
  }

  if (showAllProductButton) showAllProductButton.addEventListener('click', () => { activeFilter = 'all'; filterAndDisplayProduct(); });
  if (showMyProductButton) showMyProductButton.addEventListener('click', () => { activeFilter = 'my'; filterAndDisplayProduct(); });

  fetchProductFromServer();
});

/* ---------- delegated delete button listener ---------- */
document.addEventListener('click', (e) => {
  const del = e.target.closest && e.target.closest('.delete-btn');
  if (!del) return;
  const id = del.dataset.deleteId;
  const name = del.dataset.deleteName || '';
  showDeleteConfirm(id, name);
});

/* ---------- re-fetch on product events (unchanged) ---------- */
document.addEventListener('productAdded', () => fetchProductFromServer());
document.addEventListener('productUpdated', () => fetchProductFromServer());
</script>

{% endblock content %}